# .github/workflows/gui_weekly_training.yml
# ENTRENAMIENTO SEMANAL DEL MODELO GUI
# Se ejecuta cada domingo a las 4AM (despu√©s de an√°lisis de anti-patrones)

name: GUI - Entrenamiento Semanal

concurrency:
  group: gui-training-weekly
  cancel-in-progress: false

env:
  TZ: America/Lima
  PYTHON_VERSION: "3.11"

on:
  # Cada domingo a las 4AM
  schedule:
    - cron: "0 4 * * 0"

  # Manual dispatch para testing
  workflow_dispatch:

jobs:
  train_gui:
    name: "Entrenar Modelo GUI"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Instalar dependencias
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install supabase python-dotenv

      - name: Verificar dataset de guiones
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          echo "üìä Verificando dataset de guiones..."
          python -c "
          import os
          from supabase import create_client
          sb = create_client(os.environ['SUPABASE_URL'], os.environ['SUPABASE_SERVICE_KEY'])

          # Verificar captions
          result_captions = sb.table('captions').select('*', count='exact').execute()
          captions_count = result_captions.count if hasattr(result_captions, 'count') else len(result_captions.data)

          # Verificar scripts procesados
          result_scripts = sb.table('video_scripts').select('*', count='exact').execute()
          scripts_count = result_scripts.count if hasattr(result_scripts, 'count') else len(result_scripts.data)

          print(f'üìù Captions capturados: {captions_count}')
          print(f'‚úÖ Scripts procesados: {scripts_count}')

          if scripts_count < 10:
              print('‚ö†Ô∏è  ADVERTENCIA: Menos de 10 scripts procesados')
              print('    El modelo se entrenar√° pero con confianza limitada')
          elif scripts_count < 30:
              print('‚ö†Ô∏è  Dataset peque√±o: Confianza 50-70%')
          elif scripts_count < 100:
              print('‚úÖ Dataset bueno: Confianza 80%+')
          else:
              print('üéØ Dataset √≥ptimo: Confianza 95%+')
          "

      - name: Procesar captions a scripts
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          echo "üîÑ Procesando captions ‚Üí scripts..."
          cd "YOUTUBE ORIGENES"
          python process_captions_to_scripts.py 2>&1 | tee ../processing_log.txt
          echo "process_exit_code=$?" >> $GITHUB_OUTPUT

      - name: Entrenar modelo GUI
        id: train
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          GITHUB_SHA: ${{ github.sha }}
        run: |
          echo "üß† Entrenando modelo GUI..."
          cd "YOUTUBE ORIGENES"
          python train_gui_model.py 2>&1 | tee ../training_log.txt

          # Guardar exit code
          echo "exit_code=$?" >> $GITHUB_OUTPUT

      - name: Verificar contexto entrenado
        id: check_training
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          echo "üîç Verificando contexto entrenado..."
          python -c "
          import os
          from supabase import create_client
          sb = create_client(os.environ['SUPABASE_URL'], os.environ['SUPABASE_SERVICE_KEY'])

          # Verificar que existe el contexto
          result = sb.table('gui_training_context').select('*').eq('context_type', 'main').execute()

          if result.data:
              context = result.data[0]
              scripts_count = context.get('scripts_count', 0)
              updated_at = context.get('updated_at', 'desconocido')
              print(f'‚úÖ Contexto GUI actualizado exitosamente')
              print(f'üìä Scripts usados: {scripts_count}')
              print(f'üïí √öltima actualizaci√≥n: {updated_at}')
              print('training_success=true')
          else:
              print('‚ùå Contexto GUI NO fue actualizado')
              print('training_success=false')
          " | tee -a check_output.txt

          # Extraer resultado
          if grep -q "training_success=true" check_output.txt; then
            echo "training_success=true" >> $GITHUB_OUTPUT
          else
            echo "training_success=false" >> $GITHUB_OUTPUT
          fi

      - name: Crear artifact con logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: gui-training-logs-${{ github.run_number }}
          path: |
            processing_log.txt
            training_log.txt
          retention-days: 30

      - name: Resumen final
        if: always()
        run: |
          echo "=================================================="
          echo "RESUMEN DE ENTRENAMIENTO GUI SEMANAL"
          echo "=================================================="
          echo ""
          echo "Fecha: $(date +%Y-%m-%d\ %H:%M:%S)"
          echo "Workflow Run: ${{ github.run_number }}"
          echo "Commit: ${{ github.sha }}"
          echo ""

          if [ "${{ steps.train.outputs.exit_code }}" == "0" ]; then
            echo "Estado: ‚úÖ EXITOSO"
          else
            echo "Estado: ‚ö†Ô∏è COMPLETADO CON ADVERTENCIAS"
          fi

          if [ "${{ steps.check_training.outputs.training_success }}" == "true" ]; then
            echo "Contexto GUI: ‚úÖ ACTUALIZADO EN SUPABASE"
            echo ""
            echo "LISTO PARA USAR:"
            echo "  python evaluate_script_gui.py"
            echo ""
            echo "El evaluador de guiones ya tiene los patrones"
            echo "actualizados de tus √∫ltimos videos."
          else
            echo "Contexto GUI: ‚ùå NO ACTUALIZADO"
            echo ""
            echo "POSIBLES CAUSAS:"
            echo "- Dataset muy peque√±o (< 10 guiones)"
            echo "- Error en procesamiento de captions"
            echo "- Error de conexi√≥n con Supabase"
            echo ""
            echo "ACCI√ìN:"
            echo "- Revisar logs del entrenamiento"
            echo "- Verificar tabla captions en Supabase"
            echo "- Ejecutar manualmente: python train_gui_model.py"
          fi

          echo ""
          echo "Pr√≥ximo entrenamiento: Domingo pr√≥ximo a las 4AM"
          echo "=================================================="

      # TODO: Notificaci√≥n por email
      # - name: Enviar email resultado
      #   if: always()
      #   uses: dawidd6/action-send-mail@v3
      #   with:
      #     server_address: smtp.gmail.com
      #     server_port: 465
      #     username: ${{ secrets.EMAIL_USERNAME }}
      #     password: ${{ secrets.EMAIL_PASSWORD }}
      #     subject: |
      #       [GUI] Entrenamiento Semanal - ${{ steps.train.outputs.exit_code == '0' && '‚úÖ EXITOSO' || '‚ö†Ô∏è ADVERTENCIA' }}
      #     to: ${{ secrets.EMAIL_TO }}
      #     from: GitHub Actions <actions@github.com>
      #     body: file://training_log.txt

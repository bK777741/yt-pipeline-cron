name: üîç B√∫squeda Activa Trending (Cada 2 D√≠as)

on:
  schedule:
    # Ejecutar cada 2 d√≠as a las 06:00 UTC
    - cron: '0 6 */2 * *'

  workflow_dispatch:  # Permitir ejecuci√≥n manual
    inputs:
      force:
        description: 'Forzar ejecuci√≥n (ignorar l√≠mite de 2 d√≠as)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

env:
  YT_REFRESH_TOKEN: ${{ secrets.YT_REFRESH_TOKEN }}
  YT_CLIENT_ID: ${{ secrets.YT_CLIENT_ID }}
  YT_CLIENT_SECRET: ${{ secrets.YT_CLIENT_SECRET }}
  CHANNEL_ID: ${{ secrets.CHANNEL_ID }}
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
  FORCE_EXECUTION: ${{ github.event.inputs.force || 'false' }}

jobs:
  search_shorts:
    name: üìπ B√∫squeda Activa de Shorts
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Ejecutar fetch_shorts_search.py
        uses: nick-invision/retry@v3
        with:
          timeout_minutes: 10
          max_attempts: 3
          retry_wait_seconds: 30
          command: |
            cd scripts
            python fetch_shorts_search.py

  search_explosive_longs:
    name: üöÄ B√∫squeda de Videos Largos Explosivos
    runs-on: ubuntu-latest
    needs: search_shorts  # Ejecutar despu√©s de shorts

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Ejecutar fetch_explosive_longs.py
        uses: nick-invision/retry@v3
        with:
          timeout_minutes: 10
          max_attempts: 3
          retry_wait_seconds: 30
          command: |
            cd scripts
            python fetch_explosive_longs.py

  purge_old_trending:
    name: üóëÔ∏è Purgar Videos > 30 D√≠as
    runs-on: ubuntu-latest
    needs: [search_shorts, search_explosive_longs]  # Ejecutar al final

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      # ====================================================================
      # PASO CR√çTICO: Guardar snapshot ANTES de purgar (competencia)
      # Preserva datos de videos trending para ML
      # ====================================================================
      - name: Guardar snapshot para ML (pre-purga competencia)
        run: |
          echo "üì∏ Guardando snapshot de competencia antes de purgar..."
          cd scripts
          python save_training_snapshot.py
          echo "‚úÖ Snapshot guardado en ml_training_data"

      - name: Ejecutar purga_trending_30dias.py
        run: |
          cd scripts
          python purga_trending_30dias.py

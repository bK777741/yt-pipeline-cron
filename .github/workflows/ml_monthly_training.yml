# .github/workflows/ml_monthly_training.yml
# ENTRENAMIENTO MENSUAL DEL MODELO ML
# Se ejecuta el d√≠a 1 de cada mes a las 2AM (despu√©s de snapshot y purga)

name: ML - Entrenamiento Mensual

concurrency:
  group: ml-training-monthly
  cancel-in-progress: false

env:
  TZ: America/Lima
  PYTHON_VERSION: "3.11"

on:
  # D√≠a 1 de cada mes a las 2AM
  schedule:
    - cron: "0 2 1 * *"

  # Manual dispatch para testing
  workflow_dispatch:

jobs:
  train_model:
    name: "Entrenar Modelo Predictor"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Instalar dependencias
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install scikit-learn==1.3.0 pandas numpy

      - name: Verificar datos de entrenamiento
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          echo "üìä Verificando dataset ML..."
          python -c "
          import os
          from supabase import create_client
          sb = create_client(os.environ['SUPABASE_URL'], os.environ['SUPABASE_SERVICE_KEY'])
          result = sb.table('ml_training_data').select('*', count='exact').execute()
          print(f'‚úÖ Videos en dataset: {result.count if hasattr(result, \"count\") else len(result.data)}')
          "

      - name: Entrenar modelo predictor
        id: train
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          GITHUB_SHA: ${{ github.sha }}
        run: |
          cd "GITHUB CRON/scripts"
          python train_predictor_model.py 2>&1 | tee ../../training_log.txt

          # Guardar exit code
          echo "exit_code=$?" >> $GITHUB_OUTPUT

      - name: Verificar modelo generado
        id: check_model
        run: |
          if [ -f "GITHUB CRON/models/predictor_ensemble.pkl" ]; then
            echo "‚úÖ Modelo generado exitosamente"
            echo "model_generated=true" >> $GITHUB_OUTPUT

            # Mostrar tama√±o del modelo
            size=$(stat -f%z "GITHUB CRON/models/predictor_ensemble.pkl" 2>/dev/null || stat -c%s "GITHUB CRON/models/predictor_ensemble.pkl")
            echo "üì¶ Tama√±o del modelo: $size bytes"
          else
            echo "‚ö†Ô∏è Modelo NO fue generado (no cumpli√≥ criterios de validaci√≥n)"
            echo "model_generated=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit y push modelo
        if: steps.check_model.outputs.model_generated == 'true'
        run: |
          # Configurar git
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          # Crear directorio si no existe
          mkdir -p "GITHUB CRON/models"

          # Agregar modelo
          git add "GITHUB CRON/models/predictor_ensemble.pkl"

          # Commit con mensaje detallado
          git commit -m "$(cat <<'EOF'
          UPDATE: Modelo ML re-entrenado - $(date +%Y-%m-%d)

          ENTRENAMIENTO MENSUAL AUTOM√ÅTICO
          =================================

          Fecha: $(date +%Y-%m-%d\ %H:%M:%S)
          Commit: ${{ github.sha }}

          DATASET:
          - Ventana temporal: √öltimos 6 meses
          - Features: 12 features limpias
          - Validaci√≥n: TimeSeriesSplit (5 folds) + Hold-out test

          MODELOS:
          - Random Forest (max_depth=7, min_samples_split=30)
          - Gradient Boosting (max_depth=6, learning_rate=0.05)
          - Ridge Regression (alpha=10)

          CRITERIOS DE ACEPTACI√ìN:
          - Precisi√≥n >= 60% en clasificaci√≥n
          - R¬≤ >= 0.20
          - MAE razonable

          RESULTADO:
          ‚úÖ Modelo APROBADO y guardado
          üìä Ya disponible para predicciones

          USO:
          cd "GITHUB CRON/scripts"
          python predict_video.py

          ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

          Co-Authored-By: Claude <noreply@anthropic.com>
          EOF
          )"

          # Push al repositorio
          git push

          echo "‚úÖ Modelo commiteado y pusheado exitosamente"

      - name: Crear artifact con logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: training-logs-${{ github.run_number }}
          path: training_log.txt
          retention-days: 30

      - name: Resumen final
        if: always()
        run: |
          echo "=================================================="
          echo "RESUMEN DE ENTRENAMIENTO MENSUAL"
          echo "=================================================="
          echo ""
          echo "Fecha: $(date +%Y-%m-%d\ %H:%M:%S)"
          echo "Workflow Run: ${{ github.run_number }}"
          echo "Commit: ${{ github.sha }}"
          echo ""

          if [ "${{ steps.train.outputs.exit_code }}" == "0" ]; then
            echo "Estado: ‚úÖ EXITOSO"
          else
            echo "Estado: ‚ö†Ô∏è COMPLETADO CON ADVERTENCIAS"
          fi

          if [ "${{ steps.check_model.outputs.model_generated }}" == "true" ]; then
            echo "Modelo: ‚úÖ GENERADO Y COMMITEADO"
          else
            echo "Modelo: ‚ùå NO GENERADO (criterios no cumplidos)"
            echo ""
            echo "POSIBLES CAUSAS:"
            echo "- Dataset muy peque√±o (< 100 videos)"
            echo "- Precisi√≥n < 60%"
            echo "- R¬≤ < 0.20"
            echo ""
            echo "ACCI√ìN:"
            echo "- Revisar logs del entrenamiento"
            echo "- Esperar al pr√≥ximo mes (m√°s datos)"
            echo "- Modelo anterior se mantiene activo"
          fi

          echo ""
          echo "Pr√≥ximo entrenamiento: D√≠a 1 del pr√≥ximo mes"
          echo "=================================================="

      # TODO: Notificaci√≥n por email
      # - name: Enviar email resultado
      #   if: always()
      #   uses: dawidd6/action-send-mail@v3
      #   with:
      #     server_address: smtp.gmail.com
      #     server_port: 465
      #     username: ${{ secrets.EMAIL_USERNAME }}
      #     password: ${{ secrets.EMAIL_PASSWORD }}
      #     subject: |
      #       [ML] Entrenamiento Mensual - ${{ steps.train.outputs.exit_code == '0' && '‚úÖ EXITOSO' || '‚ö†Ô∏è ADVERTENCIA' }}
      #     to: ${{ secrets.EMAIL_TO }}
      #     from: GitHub Actions <actions@github.com>
      #     body: file://training_log.txt

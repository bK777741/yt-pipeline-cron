name: Purga Autom√°tica Supabase

on:
  # Ejecutar mensualmente (d√≠a 1 a las 03:00 UTC = 22:00 Lima d√≠a anterior)
  schedule:
    - cron: "0 3 1 * *"  # Cada mes, d√≠a 1, 03:00 UTC

  # Permitir ejecuci√≥n manual
  workflow_dispatch:
    inputs:
      force:
        description: 'Forzar purga (ignorar umbrales)'
        required: false
        type: boolean
        default: false

jobs:
  verificar_storage:
    name: "Verificar Storage y Purgar si Necesario"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip'

      - name: Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # ====================================================================
      # PASO CR√çTICO: Guardar snapshot ANTES de purgar
      # Preserva datos para entrenamiento ML
      # ====================================================================
      - name: Guardar snapshot para ML (pre-purga)
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          echo "üì∏ Guardando snapshot de datos antes de purgar..."
          cd scripts
          python save_training_snapshot.py
          echo "‚úÖ Snapshot guardado en ml_training_data"

      - name: Verificar y purgar storage
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          cd scripts
          if [ "${{ inputs.force }}" = "true" ]; then
            echo "[INFO] Purga forzada activada"
            python purga_inteligente_supabase.py --force
          else
            echo "[INFO] Verificaci√≥n autom√°tica"
            python purga_inteligente_supabase.py
          fi

      - name: Notificar resultado
        if: always()
        run: |
          echo "Purga autom√°tica completada"
          echo "Ver logs arriba para detalles"

# ============================================================================
# NOTAS - PLAN FREE (500 MB database + 1 GB storage = 1.5 GB TOTAL):
# - Este workflow se ejecuta el primer d√≠a de cada mes
# - Verifica el uso de storage autom√°ticamente
# - Alerta al 70% (1.05 GB de 1.5 GB)
# - Solo purga si storage >= 85% (1.27 GB de 1.5 GB)
# - Mantiene watermarks intactos (continuidad garantizada)
# - Conserva datos recientes (√∫ltimos 30 d√≠as NUNCA se borran)
#
# L√çMITES SUPABASE FREE TIER:
# - Database: 500 MB
# - File Storage: 1 GB
# - TOTAL: ~1.5 GB
#
# EJECUCI√ìN MANUAL:
# 1. Ir a GitHub Actions ‚Üí "Purga Autom√°tica Supabase"
# 2. Click "Run workflow"
# 3. Activar "force" solo si quieres purgar sin importar umbral
# ============================================================================

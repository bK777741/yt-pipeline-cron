name: Purga Automática Supabase

on:
  # Ejecutar mensualmente (día 1 a las 03:00 UTC = 22:00 Lima día anterior)
  schedule:
    - cron: "0 3 1 * *"  # Cada mes, día 1, 03:00 UTC

  # Permitir ejecución manual
  workflow_dispatch:
    inputs:
      force:
        description: 'Forzar purga (ignorar umbrales)'
        required: false
        type: boolean
        default: false

jobs:
  verificar_storage:
    name: "Verificar Storage y Purgar si Necesario"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip'

      - name: Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Verificar y purgar storage
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          cd scripts
          if [ "${{ inputs.force }}" = "true" ]; then
            echo "[INFO] Purga forzada activada"
            python purga_inteligente_supabase.py --force
          else
            echo "[INFO] Verificación automática"
            python purga_inteligente_supabase.py
          fi

      - name: Notificar resultado
        if: always()
        run: |
          echo "Purga automática completada"
          echo "Ver logs arriba para detalles"

# ============================================================================
# NOTAS:
# - Este workflow se ejecuta el primer día de cada mes
# - Verifica el uso de storage automáticamente
# - Solo purga si storage >= 90% (450 GB de 500 GB)
# - Mantiene watermarks intactos (continuidad garantizada)
# - Conserva datos recientes (últimos 30 días NUNCA se borran)
#
# EJECUCIÓN MANUAL:
# 1. Ir a GitHub Actions → "Purga Automática Supabase"
# 2. Click "Run workflow"
# 3. Activar "force" solo si quieres purgar sin importar umbral
# ============================================================================

# .github/workflows/ml_system.yml
# SISTEMA ML PREDICTOR - WORKFLOW H√çBRIDO
#
# ESTRATEGIA:
# - SEMANAL: An√°lisis de anti-patrones (domingos 3AM) - NO entrena
# - MENSUAL: Snapshot + Re-entrenamiento completo (d√≠a 1 de cada mes)
#
# CUOTA API: 0 unidades (solo lee de Supabase)

name: Sistema ML Predictor

concurrency:
  group: ml-system-${{ github.ref }}-${{ github.event.schedule || 'manual' }}
  cancel-in-progress: false # NO cancelar, estos jobs son cr√≠ticos

env:
  TZ: America/Lima
  PYTHON_VERSION: "3.11"

# ========= TRIGGERS =========
on:
  # 1. An√°lisis semanal: Cada domingo a las 3AM
  schedule:
    - cron: "0 3 * * 0"  # Domingos 3AM Lima

  # 2. Entrenamiento mensual: D√≠a 1 de cada mes a las 2AM
  # schedule:
  #   - cron: "0 2 1 * *"  # D√≠a 1 de cada mes 2AM Lima
  # NOTA: Se ejecuta desde workflow separado para evitar conflictos

  # 3. Manual dispatch
  workflow_dispatch:
    inputs:
      job:
        description: "Ejecutar solo este job"
        required: false
        type: choice
        options:
          - ""
          - analisis_semanal
          - snapshot_pre_purga
          - entrenar_modelo

# ========= JOBS =========
jobs:
  # =====================================================================
  # JOB 1: AN√ÅLISIS SEMANAL (Domingos 3AM)
  # Detecta anti-patrones en videos de la √∫ltima semana
  # NO entrena modelo, solo analiza y alerta
  # =====================================================================
  analisis_semanal:
    name: "An√°lisis Semanal Anti-Patrones"
    runs-on: ubuntu-latest
    if: |
      github.event.schedule == '0 3 * * 0' ||
      github.event.inputs.job == '' ||
      github.event.inputs.job == 'analisis_semanal'

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Instalar dependencias
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Ejecutar an√°lisis semanal
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          cd GITHUB\ CRON/scripts
          python analizar_anti_patrones_semanal.py

      - name: Verificar anti-patrones detectados
        run: |
          echo "‚úÖ An√°lisis semanal completado"
          echo "üìä Pr√≥ximo an√°lisis: Domingo siguiente"

      # TODO: Enviar email con reporte semanal
      # - name: Enviar email reporte
      #   if: always()
      #   uses: dawidd6/action-send-mail@v3
      #   with:
      #     server_address: smtp.gmail.com
      #     server_port: 465
      #     username: ${{ secrets.EMAIL_USERNAME }}
      #     password: ${{ secrets.EMAIL_PASSWORD }}
      #     subject: "[ML] An√°lisis Semanal Completado"
      #     body: file://reporte_semanal.txt

  # =====================================================================
  # JOB 2: SNAPSHOT PRE-PURGA (Antes del d√≠a 1 de cada mes)
  # Guarda datos de videos antes de que sean purgados
  # Se ejecuta AUTOM√ÅTICAMENTE desde workflow de purga
  # =====================================================================
  snapshot_pre_purga:
    name: "Snapshot de datos (pre-purga)"
    runs-on: ubuntu-latest
    if: |
      github.event.inputs.job == 'snapshot_pre_purga'

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Instalar dependencias
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Guardar snapshot para ML
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          cd GITHUB\ CRON/scripts
          python save_training_snapshot.py

      - name: Verificar snapshot guardado
        run: |
          echo "‚úÖ Snapshot guardado en ml_training_data"
          echo "üìä Datos preservados antes de purga"

  # =====================================================================
  # JOB 3: ENTRENAMIENTO MENSUAL (D√≠a 1 de cada mes)
  # Entrena modelo ML con datos de √∫ltimos 6 meses
  # Solo guarda modelo si precisi√≥n >= 60%
  # =====================================================================
  entrenar_modelo:
    name: "Entrenamiento Mensual Modelo ML"
    runs-on: ubuntu-latest
    if: |
      github.event.inputs.job == 'entrenar_modelo'

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Instalar dependencias ML
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install scikit-learn pandas numpy

      - name: Entrenar modelo predictor
        id: train
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          cd GITHUB\ CRON/scripts
          python train_predictor_model.py

      - name: Commit modelo entrenado
        if: success()
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          # Agregar modelo si fue creado
          if [ -f "GITHUB CRON/models/predictor_ensemble.pkl" ]; then
            git add "GITHUB CRON/models/predictor_ensemble.pkl"

            git commit -m "$(cat <<'EOF'
          UPDATE: Modelo ML entrenado - $(date +%Y-%m)

          Entrenamiento mensual autom√°tico completado
          - Precisi√≥n: Ver logs del workflow
          - Dataset: √öltimos 6 meses
          - Validaci√≥n: TimeSeriesSplit + Hold-out test

          ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

          Co-Authored-By: Claude <noreply@anthropic.com>
          EOF
          )"

            git push
            echo "‚úÖ Modelo commiteado exitosamente"
          else
            echo "‚ö†Ô∏è Modelo no fue generado (no cumpli√≥ criterios de validaci√≥n)"
          fi

      - name: Notificar resultado
        if: always()
        run: |
          if [ "${{ steps.train.outcome }}" == "success" ]; then
            echo "‚úÖ Entrenamiento EXITOSO"
            echo "üìä Modelo listo para predicciones"
          else
            echo "‚ùå Entrenamiento FALL√ì"
            echo "üìä Verificar logs para detalles"
          fi

      # TODO: Enviar email con resultado de entrenamiento
      # - name: Enviar email resultado
      #   if: always()
      #   uses: dawidd6/action-send-mail@v3
      #   with:
      #     server_address: smtp.gmail.com
      #     server_port: 465
      #     username: ${{ secrets.EMAIL_USERNAME }}
      #     password: ${{ secrets.EMAIL_PASSWORD }}
      #     subject: "[ML] Entrenamiento Mensual - ${{ steps.train.outcome }}"
      #     body: file://reporte_entrenamiento.txt

# =====================================================================
# NOTAS DE IMPLEMENTACI√ìN
# =====================================================================
#
# 1. ORDEN DE EJECUCI√ìN MENSUAL:
#    - D√≠a 28-30: snapshot_pre_purga (guardar datos)
#    - D√≠a 1: purga_automatica (eliminar videos viejos)
#    - D√≠a 1: entrenar_modelo (entrenar con datos guardados)
#
# 2. INTEGRACI√ìN CON WORKFLOW DE PURGA:
#    - El job snapshot_pre_purga se debe llamar desde purga_automatica_supabase.yml
#    - Usar workflow_call para ejecutarlo antes de purgar
#
# 3. RETRY LOGIC:
#    - An√°lisis semanal: Se reintenta autom√°ticamente (no cr√≠tico)
#    - Entrenamiento: Si falla, mantiene modelo anterior
#    - Snapshot: CR√çTICO - debe ejecutarse antes de purga
#
# 4. MONITOREO:
#    - Verificar logs en GitHub Actions
#    - Revisar tabla modelo_ml_metadata en Supabase
#    - Dashboard local muestra estado del sistema
#
# =====================================================================
